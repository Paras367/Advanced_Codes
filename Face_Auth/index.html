<!DOCTYPE html>
<html>
<head>
    <title>Face Detection (MediaPipe)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #video, #canvas { width: 640px; height: 480px; border: 1px solid #ccc; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>✅ Working Face Detection</h1>
    
    <div id="init-screen">
        <button onclick="startCamera()">Start Camera</button>
    </div>

    <div id="camera-screen" class="hidden">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas" width="640" height="480"></canvas>
        <button onclick="stopCamera()">Stop</button>
    </div>

    <script>
        let stream = null;
        let faceMesh = null;
        let isRunning = false;

        // Initialize MediaPipe FaceMesh
        async function initFaceMesh() {
            if (faceMesh) return;
            faceMesh = new FaceMesh({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
            });
            faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true });
        }

        async function startCamera() {
            await initFaceMesh();
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                document.getElementById('init-screen').classList.add('hidden');
                document.getElementById('camera-screen').classList.remove('hidden');
                isRunning = true;
                processVideo();
            } catch (err) {
                alert('⚠️ Camera access denied');
            }
        }

        function stopCamera() {
            isRunning = false;
            if (stream) stream.getTracks().forEach(track => track.stop());
            document.getElementById('camera-screen').classList.add('hidden');
            document.getElementById('init-screen').classList.remove('hidden');
        }

        async function processVideo() {
            if (!isRunning) return;
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            if (video.readyState >= 2) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const predictions = await faceMesh.send({ image: video });
                if (predictions.length > 0) {
                    const landmarks = predictions[0].landmarks;
                    
                    // Draw face mesh
                    ctx.strokeStyle = '#4361ee';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    for (let i = 0; i < landmarks.length; i += 3) {
                        const x = landmarks[i] * canvas.width;
                        const y = landmarks[i + 1] * canvas.height;
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                }
            }
            
            requestAnimationFrame(processVideo);
        }

        console.log('Ready to detect faces!');
    </script>
</body>
</html>
