<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Secure Face ID Login & Attendance System ‚Äì Privacy First, No Image Uploads. Built for Bharat with sovereign AI.">
  <title>BHARAT FaceID | A Nation Rising</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
    #video, #canvas { width: 640px; height: 480px; border: 1px solid #ccc; margin: 10px auto; display: block; }
    .hidden { display: none; }
    button { padding: 10px 20px; margin: 5px; font-size: 16px; }
    #status { margin: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>BHARAT FaceID</h1>
  
  <div id="init-screen">
    <input type="text" id="nameInput" placeholder="Your Name" />
    <br><br>
    <button onclick="startEnroll()">:Register Face</button>
    <button onclick="startRecognition()">üîì Login</button>
  </div>

  <div id="camera-screen" class="hidden">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    <div id="status">Initializing...</div>
    <button onclick="stopCamera()">‚Üê Back</button>
  </div>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

  <script>
    const WORKER_URL = 'https://face-auth-worker.dhimanparas605.workers.dev';
    let stream = null;
    let faceMesh = null;
    let isRunning = false;

    // Initialize MediaPipe
    async function initFaceMesh() {
      if (faceMesh) return;
      faceMesh = new FaceMesh({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
      });
      faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true });
    }

    // Blink detection
    function isBlinking(landmarks) {
      if (!landmarks || landmarks.length < 474) return false;
      
      // Convert flat array to points
      const points = [];
      for (let i = 0; i < landmarks.length; i += 3) {
        points.push({ x: landmarks[i], y: landmarks[i + 1] });
      }
      
      // Left eye indices
      const leftEye = [33, 160, 159, 158, 133, 153, 145, 144].map(i => points[i]);
      const rightEye = [263, 387, 386, 385, 362, 380, 374, 373].map(i => points[i]);
      
      if (leftEye.some(p => !p) || rightEye.some(p => !p)) return false;
      
      const computeEAR = (eye) => {
        const A = Math.sqrt(Math.pow(eye[1].x - eye[7].x, 2) + Math.pow(eye[1].y - eye[7].y, 2));
        const B = Math.sqrt(Math.pow(eye[2].x - eye[6].x, 2) + Math.pow(eye[2].y - eye[6].y, 2));
        const C = Math.sqrt(Math.pow(eye[3].x - eye[5].x, 2) + Math.pow(eye[3].y - eye[5].y, 2));
        const D = Math.sqrt(Math.pow(eye[0].x - eye[4].x, 2) + Math.pow(eye[0].y - eye[4].y, 2));
        return (A + B + C) / (3.0 * D);
      };
      
      const leftEAR = computeEAR(leftEye);
      const rightEAR = computeEAR(rightEye);
      const avgEAR = (leftEAR + rightEAR) / 2;
      console.log('EAR:', avgEAR.toFixed(3));
      return avgEAR < 0.25;
    }

    async function startCamera() {
      await initFaceMesh();
      
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        const video = document.getElementById('video');
        video.srcObject = stream;
        
        // Wait for video to load
        await new Promise((resolve) => {
          video.onloadedmetadata = () => resolve();
          video.play();
        });
        
        document.getElementById('init-screen').classList.add('hidden');
        document.getElementById('camera-screen').classList.remove('hidden');
        isRunning = true;
        setStatus('üëÄ Look at camera and blink...');
        processVideo();
      } catch (err) {
        alert('‚ö†Ô∏è Camera access denied.');
        console.error(err);
      }
    }

    function stopCamera() {
      isRunning = false;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      document.getElementById('camera-screen').classList.add('hidden');
      document.getElementById('init-screen').classList.remove('hidden');
    }

    function setStatus(text) {
      document.getElementById('status').textContent = text;
    }

    async function processVideo() {
      if (!isRunning) return;
      
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      // Only process if video is ready
      if (video.readyState >= 2) { // HAVE_CURRENT_DATA or better
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        try {
          const predictions = await faceMesh.send({ image: video });
          
          if (predictions.length > 0 && predictions[0].landmarks) {
            const landmarks = predictions[0].landmarks;
            
            // Draw face mesh
            ctx.strokeStyle = '#4361ee';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i < landmarks.length; i += 3) {
              const x = landmarks[i] * canvas.width;
              const y = landmarks[i + 1] * canvas.height;
              if (i === 0) ctx.moveTo(x, y);
              else ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Blink detection
            if (isBlinking(landmarks)) {
              setStatus('‚úÖ Blink detected!');
              // You can now trigger enrollment/recognition
            } else {
              setStatus('üëÄ Look at camera and blink...');
            }
          } else {
            setStatus('No face detected');
          }
        } catch (e) {
          console.error('Processing error:', e);
          setStatus('Processing error');
        }
      }

      requestAnimationFrame(processVideo);
    }

    async function startEnroll() {
      const name = document.getElementById('nameInput').value.trim();
      if (!name) return alert('Enter name');
      await startCamera();
      // Add enrollment logic here when blink is detected
    }

    async function startRecognition() {
      await startCamera();
      // Add recognition logic here when blink is detected
    }

    console.log('Ready!');
  </script>
</body>
</html>
