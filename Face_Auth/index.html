<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Secure Face ID Login & Attendance ‚Äì Privacy First, No Image Uploads">
  
  <!-- üîó Performance: Preconnect -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://face-auth-worker.dhimanparas605.workers.dev">

  <!-- üé® Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@500;600&family=Orbitron:wght@500&display=swap" rel="stylesheet">

  <!-- ‚ö° Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <title>üîê BHARAT FaceID | A Nation Rising</title>

  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --success: #06d6a0;
      --danger: #ef476f;
      --dark: #1d3557;
      --light: #f8f9fa;
      --gray: #6c757d;
      --wave-bg: #0d1b2a;
      --card-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
      color: var(--dark);
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      background: white;
      box-shadow: var(--shadow);
      padding: 1rem 5%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
    }

    .logo i { font-size: 1.8rem; color: var(--primary); }
    .logo h1 {
      font-family: 'Orbitron', sans-serif;
      font-weight: 600;
      font-size: 1.5rem;
      background: linear-gradient(90deg, var(--primary), #7209b7);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    main {
      max-width: 800px;
      margin: 2.5rem auto;
      padding: 0 1.5rem;
    }

    .hero { text-align: center; margin-bottom: 2rem; }
    .hero h2 {
      font-family: 'Poppins', sans-serif;
      font-size: 2.2rem;
      margin-bottom: 0.8rem;
    }
    .hero p { color: var(--gray); max-width: 600px; margin: 0 auto; line-height: 1.6; }

    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .input-group { margin-bottom: 1.5rem; }
    .input-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    .input-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 1rem;
    }
    .input-group input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
    }
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(67, 97, 238, 0.4);
    }
    .btn-success { background: var(--success); }
    .btn-secondary { background: #6c757d; }

    #camera-screen { display: none; text-align: center; }
    #video-container {
      position: relative;
      display: inline-block;
      margin: 0 auto 1.5rem;
    }
    #video, #canvas {
      width: 100%;
      max-width: 640px;
      height: auto;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
    }

    #status { font-weight: 600; margin: 1rem 0; min-height: 1.5rem; }
    .status-live { color: var(--success); }
    .status-warn { color: var(--danger); }
    .status-info { color: var(--gray); }

    #result {
      font-size: 1.3rem;
      font-weight: 700;
      margin: 1rem 0;
      min-height: 1.8rem;
    }
    .result-success { color: var(--success); }
    .result-error { color: var(--danger); }

    footer {
      background: var(--wave-bg);
      color: white;
      text-align: center;
      padding: 4rem 2rem 2rem;
      position: relative;
      margin-top: 4rem;
    }
    footer::before {
      content: "";
      position: absolute;
      top: -40px;
      left: 0;
      width: 100%;
      height: 60px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%230d1b2a' fill-opacity='1' d='M0,128L48,138.7C96,149,192,171,288,186.7C384,203,480,213,576,208C672,203,768,181,864,186.7C960,192,1056,224,1152,229.3C1248,235,1344,213,1392,202.7L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
      background-size: cover;
    }
    .footer-content h3 {
      font-family: 'Orbitron', sans-serif;
      margin-bottom: 1rem;
    }
    .copyright { margin-top: 2rem; opacity: 0.8; font-size: 0.95rem; }

    @media (max-width: 768px) {
      .hero h2 { font-size: 1.8rem; }
      .card { padding: 1.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <a href="#" class="logo">
      <i class="fas fa-shield-alt"></i>
      <h1>BHARAT FaceID</h1>
    </a>
  </header>

  <main>
    <section class="hero">
      <h2><i class="fas fa-face-recognition"></i> Secure Face Recognition</h2>
      <p>Privacy-first biometric authentication. No images stored ‚Äî only mathematical descriptors.</p>
    </section>

    <div class="card" id="init-screen">
      <div class="input-group">
        <label for="nameInput"><i class="fas fa-user-tag"></i> Your Full Name</label>
        <input type="text" id="nameInput" placeholder="e.g., Paras Dhiman" autocomplete="name" />
      </div>
      <button class="btn" onclick="startEnroll()">
        <i class="fas fa-user-plus"></i> Register Face
      </button>
      <button class="btn btn-success" onclick="startRecognition()">
        <i class="fas fa-door-open"></i> Face Login & Attendance
      </button>
    </div>

    <div class="card" id="camera-screen">
      <div id="video-container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas" width="640" height="480"></canvas>
      </div>
      <div id="status" class="status-info">Initializing camera...</div>
      <div id="result"></div>
      <button class="btn btn-secondary" onclick="stopCamera()">
        <i class="fas fa-arrow-left"></i> Back
      </button>
    </div>
  </main>

  <footer>
    <div class="footer-content">
      <h3><i class="fas fa-flag"></i> BHARAT - A Nation Rising</h3>
      <p>Empowering India with secure, sovereign, and privacy-respecting AI technologies.</p>
      <div class="copyright">
        &copy; 2026 BHARAT AI Labs. All rights reserved.
      </div>
    </div>
  </footer>

  <!-- üß† Face-API -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

 <script>
  const MODEL_URL = 'weights';
  const WORKER_URL = 'https://face-auth-worker.dhimanparas605.workers.dev';

  let stream = null;
  let isRunning = false;

  async function loadModels() {
    await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
  }

  // ‚úÖ SAFE BLINK DETECTION WITH VALIDATION
  function isBlinkingSafe(landmarks) {
    try {
      if (!landmarks || !landmarks.positions || landmarks.positions.length < 48) {
        return false;
      }
      const pts = landmarks.positions;
      const leftEye = [pts[36], pts[37], pts[38], pts[39], pts[40], pts[41]];
      const rightEye = [pts[42], pts[43], pts[44], pts[45], pts[46], pts[47]];

      // Validate points exist
      if (leftEye.some(p => !p) || rightEye.some(p => !p)) return false;

      const earLeft = computeEAR(leftEye);
      const earRight = computeEAR(rightEye);
      const avgEAR = (earLeft + earRight) / 2;

      // üîç Debug: uncomment to see values
       console.log('EAR:', avgEAR.toFixed(3));

      return avgEAR < 0.26; // tolerant threshold
    } catch (e) {
      return false;
    }
  }

  function computeEAR(eye) {
    const A = Math.sqrt(Math.pow(eye[1].x - eye[5].x, 2) + Math.pow(eye[1].y - eye[5].y, 2));
    const B = Math.sqrt(Math.pow(eye[2].x - eye[4].x, 2) + Math.pow(eye[2].y - eye[4].y, 2));
    const C = Math.sqrt(Math.pow(eye[0].x - eye[3].x, 2) + Math.pow(eye[0].y - eye[3].y, 2));
    return (A + B) / (2.0 * C);
  }

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      document.getElementById('video').srcObject = stream;
      document.getElementById('init-screen').style.display = 'none';
      document.getElementById('camera-screen').style.display = 'block';
      isRunning = true;
      setStatus('üëÄ Look at camera and blink slowly...', 'info');
    } catch (err) {
      alert('‚ö†Ô∏è Camera access denied.');
    }
  }

  function stopCamera() {
    isRunning = false;
    if (stream) stream.getTracks().forEach(t => t.stop());
    document.getElementById('camera-screen').style.display = 'none';
    document.getElementById('init-screen').style.display = 'block';
  }

  function setStatus(text, type) {
    const el = document.getElementById('status');
    el.textContent = text;
    el.className = `status-${type}`;
  }

  function setResult(text, type) {
    const el = document.getElementById('result');
    el.textContent = text;
    el.className = `result-${type}`;
  }

  // ‚úÖ ENROLL WITH DEBUG
  async function startEnroll() {
    const name = document.getElementById('nameInput').value.trim();
    if (!name) return alert('Enter name');
    await loadModels();
    await startCamera();

    const capture = async () => {
      if (!isRunning) return;
      const video = document.getElementById('video');
      const detections = await faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.7 }))
        .withFaceLandmarks()
        .withFaceDescriptors();

      if (detections.length > 0) {
        const detection = detections[0];
        const blinking = isBlinkingSafe(detection.landmarks);
        
        if (blinking) {
          setStatus('‚úÖ Blink confirmed! Enrolling...', 'live');
          try {
            const res = await fetch(`${WORKER_URL}/enroll`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name, descriptor: Array.from(detection.descriptor) })
            });
            const data = await res.json();
            setResult(data.success ? `‚úÖ ${name}, enrolled!` : '‚ùå Failed', data.success ? 'success' : 'error');
          } catch (e) {
            setResult('‚ùå Network error', 'error');
          }
          setTimeout(stopCamera, 2000);
          return;
        }
      }

      setTimeout(capture, 200);
    };
    capture();
  }

  // ‚úÖ RECOGNITION
  async function startRecognition() {
    await loadModels();
    await startCamera();

    const recognize = async () => {
      if (!isRunning) return;
      const video = document.getElementById('video');
      const detections = await faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.7 }))
        .withFaceLandmarks()
        .withFaceDescriptors();

      if (detections.length > 0) {
        const detection = detections[0];
        const blinking = isBlinkingSafe(detection.landmarks);
        
        if (blinking) {
          setStatus('‚úÖ Blink confirmed! Recognizing...', 'live');
          try {
            const res = await fetch(`${WORKER_URL}/descriptors`);
            const users = await res.json();
            let match = null;
            for (const u of users) {
              const dist = faceapi.euclideanDistance(detection.descriptor, Float32Array.from(u.descriptor));
              if (dist < 0.6) {
                match = u.name;
                break;
              }
            }
            if (match) {
              await fetch(`${WORKER_URL}/attendance`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: match })
              });
              setResult(`‚úÖ Welcome, ${match}!`, 'success');
            } else {
              setResult('‚ùå Not recognized', 'error');
            }
          } catch (e) {
            setResult('‚ùå Error', 'error');
          }
          setTimeout(stopCamera, 2000);
          return;
        }
      }

      setTimeout(recognize, 200);
    };
    recognize();
  }

  // üöÄ Init
  loadModels().then(() => console.log('‚úÖ Models ready'));
</script>
