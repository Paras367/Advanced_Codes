<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üåç GSID ‚Äî Global Intelligence Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --bg2: #1e293b;
      --glass-bg: rgba(30, 30, 40, 0.6);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --text: #f1f5f9;
      --text2: #9ca3af;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, var(--bg), var(--bg2));
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      padding: 1rem;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      border-radius: 16px;
      padding: 1.25rem;
    }
    .grid { display: grid; gap: 1.5rem; }
    .grid-1 { grid-template-columns: 1fr; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    @media (min-width: 1024px) { 
      .lg-grid-3 { grid-template-columns: 2fr 1fr; }
    }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .flex-col { flex-direction: column; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .text-center { text-align: center; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-2 { margin-top: 0.5rem; }
    .mt-4 { margin-top: 1rem; }
    .mt-10 { margin-top: 2.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-5 { padding: 1.25rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
    .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
    .rounded { border-radius: 0.25rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .bg-gray-800 { background-color: #1f2937; }
    .bg-gray-700 { background-color: #374151; }
    .bg-blue-500 { background-color: #3b82f6; }
    .bg-blue-900 { background-color: rgba(30, 58, 138, 0.2); }
    .bg-green-500 { background-color: #10b981; }
    .bg-yellow-500 { background-color: #eab308; }
    .bg-orange-500 { background-color: #f97316; }
    .bg-red-500 { background-color: #ef4444; }
    .bg-red-900 { background-color: rgba(127, 29, 29, 0.3); }
    .text-white { color: #fff; }
    .text-gray-400 { color: #9ca3af; }
    .text-gray-500 { color: #6b7280; }
    .text-blue-300 { color: #93c5fd; }
    .text-blue-400 { color: #60a5fa; }
    .text-emerald-400 { color: #34d399; }
    .text-red-400 { color: #f87171; }
    .text-amber-400 { color: #fbbf24; }
    .border { border-width: 1px; }
    .border-l-4 { border-left-width: 4px; }
    .border-t { border-top-width: 1px; }
    .border-gray-800 { border-color: #1f2937; }
    .border-red-500 { border-color: #ef4444; }
    .hidden { display: none; }
    .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .line-clamp-2 { 
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .spinner {
      width: 24px; height: 24px;
      border: 3px solid #374151;
      border-top: 3px solid #4f46e5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .country-btn {
      background-color: #1f2937;
      padding: 0.75rem;
      border-radius: 0.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.875rem;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .country-btn:hover { background-color: #374151; }
    .country-btn.active { border-color: #3b82f6; }
    
    .flag-img {
      width: 64px;
      height: 48px;
      object-fit: cover;
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .news-item {
      background-color: rgba(31, 41, 55, 0.2);
      padding: 0.75rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
      text-decoration: none;
      color: inherit;
      display: block;
    }
    .news-item:hover { 
      background-color: rgba(55, 65, 81, 0.3);
    }
    .news-item:hover h4 { color: #93c5fd; }
    
    .gradient-text {
      background: linear-gradient(to right, #60a5fa, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    canvas { max-height: 250px !important; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.5s ease forwards; }
  </style>
</head>
<body>
  <div class="container">
    <header class="flex flex-col gap-4 mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold gradient-text">üåê GSID Dashboard</h1>
          <p class="text-gray-400 text-sm mt-1">Real-time global intelligence ‚Äî weather, quakes, air, news & time</p>
        </div>
        <button id="themeToggle" class="px-4 py-2 glass rounded-lg flex items-center gap-2">üåô Dark</button>
      </div>
    </header>

    <div id="errorBanner" class="hidden bg-red-900 border-l-4 border-red-500 p-4 mb-6 rounded">
      <div class="flex items-center">
        <span class="mr-2">‚ö†Ô∏è</span>
        <span id="errorMessage"></span>
      </div>
    </div>

    <section class="grid lg-grid-3 mb-6">
      <div class="glass p-5">
        <h2 class="font-semibold mb-4 flex items-center gap-2">
          <span>üåç World Intelligence Map</span>
          <span class="text-xs bg-blue-900 px-2 py-1 rounded">Click a country</span>
        </h2>
        <div id="countryGrid" class="grid grid-2 gap-3"></div>
        <p class="text-xs text-gray-500 mt-4 text-center">Tip: More countries can be added easily.</p>
      </div>

      <div id="countryPanel" class="glass p-5 hidden">
        <div class="flex items-start gap-3 mb-4">
          <img id="flagImg" src="" alt="Flag" class="flag-img">
          <div>
            <h2 id="countryName" class="text-xl font-bold"></h2>
            <p id="countrySub" class="text-gray-400 text-sm"></p>
          </div>
        </div>
        <div id="countryDetails" class="grid grid-2 gap-2 text-sm"></div>
      </div>
    </section>

    <section id="coreMetrics" class="grid grid-4 mb-6">
      <div class="glass p-5">
        <h3 class="font-semibold mb-3">üå¶ Weather</h3>
        <div id="weatherCard" class="flex items-center justify-center" style="min-height: 100px;">Select a country</div>
      </div>
      <div class="glass p-5">
        <h3 class="font-semibold mb-3">üå¨ Air Quality</h3>
        <div id="aqiCard" class="flex items-center justify-center" style="min-height: 100px;">Select a country</div>
      </div>
      <div class="glass p-5">
        <h3 class="font-semibold mb-3">‚è∞ Local Time</h3>
        <div id="clockCard" class="flex flex-col justify-center text-sm" style="min-height: 100px;">Select a country</div>
      </div>
      <div class="glass p-5">
        <h3 class="font-semibold mb-3">üåç Earthquakes</h3>
        <div id="eqCard" class="flex flex-col items-center justify-center" style="min-height: 100px;">
          <div class="spinner"></div>
        </div>
      </div>
    </section>

    <section id="chartSection" class="grid grid-2 mb-6 hidden">
      <div class="glass p-4">
        <h3 class="font-semibold mb-2">üå¨ Air Quality Forecast (12h)</h3>
        <canvas id="aqiChart"></canvas>
      </div>
      <div class="glass p-4">
        <h3 class="font-semibold mb-2">üåç Recent Quakes (M ‚â• 4.5)</h3>
        <canvas id="eqChart"></canvas>
      </div>
    </section>

    <section class="glass p-5 mb-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-semibold">üì∞ Global News Feed</h3>
        <span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">GNews ‚Ä¢ Live</span>
      </div>
      <div id="newsGrid" class="grid grid-2 gap-4">
        <div class="bg-gray-800 p-3 rounded-lg">
          <div style="height: 1rem; background: #374151; border-radius: 0.25rem; width: 75%; margin-bottom: 0.5rem;"></div>
          <div style="height: 0.75rem; background: #374151; border-radius: 0.25rem; width: 50%;"></div>
        </div>
        <div class="bg-gray-800 p-3 rounded-lg">
          <div style="height: 1rem; background: #374151; border-radius: 0.25rem; width: 75%; margin-bottom: 0.5rem;"></div>
          <div style="height: 0.75rem; background: #374151; border-radius: 0.25rem; width: 50%;"></div>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-center text-gray-500 text-sm border-t border-gray-800 py-6">
      <p>GSID ‚Äî Global Situation Intelligence Dashboard ‚Ä¢ All data from free public APIs</p>
      <p class="mt-1 text-xs">REST Countries ‚Ä¢ Open-Meteo ‚Ä¢ USGS ‚Ä¢ WorldTimeAPI ‚Ä¢ GNews</p>
    </footer>
  </div>

  <script>
    const GNEWS_API_KEY = '2c54a1cba6fec4322a101abd10e3b514';
    
    const cache = new Map();
    const CACHE_TTL = 5 * 60 * 1000;

    async function cachedFetch(url) {
      const now = Date.now();
      if (cache.has(url)) {
        const { data, timestamp } = cache.get(url);
        if (now - timestamp < CACHE_TTL) return data;
      }
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        cache.set(url, { data, timestamp: now });
        return data;
      } catch (err) {
        if (cache.has(url)) return cache.get(url).data;
        throw err;
      }
    }

    const countries = [
      { code: 'US', name: 'United States', flag: 'üá∫üá∏' },
      { code: 'IN', name: 'India', flag: 'üáÆüá≥' },
      { code: 'BR', name: 'Brazil', flag: 'üáßüá∑' },
      { code: 'DE', name: 'Germany', flag: 'üá©üá™' },
      { code: 'AU', name: 'Australia', flag: 'üá¶üá∫' },
      { code: 'JP', name: 'Japan', flag: 'üáØüáµ' },
      { code: 'ZA', name: 'South Africa', flag: 'üáøüá¶' },
      { code: 'CA', name: 'Canada', flag: 'üá®üá¶' },
      { code: 'FR', name: 'France', flag: 'üá´üá∑' },
      { code: 'MX', name: 'Mexico', flag: 'üá≤üáΩ' }
    ];

    const countryGrid = document.getElementById('countryGrid');
    countries.forEach(c => {
      const btn = document.createElement('button');
      btn.className = 'country-btn' + (c.code === 'US' ? ' active' : '');
      btn.dataset.code = c.code;
      btn.innerHTML = `<span style="font-size: 1.125rem;">${c.flag}</span><span>${c.code}</span>`;
      btn.onclick = () => loadCountry(c.code);
      countryGrid.appendChild(btn);
    });

    let aqiChart = null;
    let eqChart = null;

    async function loadCountry(code) {
      document.querySelectorAll('.country-btn').forEach(b => b.classList.remove('active'));
      const activeBtn = document.querySelector(`.country-btn[data-code="${code}"]`);
      if (activeBtn) activeBtn.classList.add('active');

      const weatherCard = document.getElementById('weatherCard');
      const aqiCard = document.getElementById('aqiCard');
      const clockCard = document.getElementById('clockCard');

      weatherCard.innerHTML = '<div class="spinner"></div>';
      aqiCard.innerHTML = '<div class="spinner"></div>';
      clockCard.innerHTML = 'Loading...';
      document.getElementById('countryPanel').classList.add('hidden');
      document.getElementById('errorBanner').classList.add('hidden');

      try {
        const countryData = await cachedFetch(`https://restcountries.com/v3.1/alpha/${code}`);
        const country = countryData[0];

        document.getElementById('flagImg').src = country.flags.svg;
        document.getElementById('countryName').textContent = country.name.common;
        document.getElementById('countrySub').textContent = `${country.region} ‚Ä¢ ${country.subregion}`;
        
        const details = [
          { k: 'Capital', v: country.capital?.[0] || '‚Äî' },
          { k: 'Population', v: new Intl.NumberFormat().format(country.population) },
          { k: 'Area', v: `${country.area?.toLocaleString() || '‚Äî'} km¬≤` },
          { k: 'Languages', v: Object.values(country.languages || {}).join(', ') || '‚Äî' },
          { k: 'Currency', v: Object.values(country.currencies || {})[0]?.name || '‚Äî' },
          { k: 'Timezone', v: country.timezones?.[0] || 'UTC' }
        ];
        
        document.getElementById('countryDetails').innerHTML = details.map(d => `
          <div><span class="text-gray-400">${d.k}:</span></div>
          <div class="font-semibold">${d.v}</div>
        `).join('');

        document.getElementById('countryPanel').classList.remove('hidden');

        const lat = country.latlng[0];
        const lng = country.latlng[1];

        const weather = await cachedFetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`
        );
        const w = weather.current_weather;
        weatherCard.innerHTML = `
          <div>
            <div class="text-3xl font-bold">${Math.round(w.temperature)}¬∞C</div>
            <div class="text-sm mt-1 text-gray-400">üí® ${w.windspeed} km/h</div>
          </div>
        `;

        const aqiData = await cachedFetch(
          `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lng}&hourly=us_aqi&forecast_days=1`
        );
        const aqiVals = aqiData.hourly?.us_aqi || [];
        const latest = aqiVals.length ? Math.round(Math.max(...aqiVals.slice(-3))) : 0;

        let level = '‚Äî', color = 'bg-gray-500', desc = 'No data';
        if (latest > 0) {
          if (latest <= 50) { level = 'Good'; color = 'bg-green-500'; desc = 'Air quality is satisfactory'; }
          else if (latest <= 100) { level = 'Moderate'; color = 'bg-yellow-500'; desc = 'Acceptable for most'; }
          else if (latest <= 150) { level = 'Unhealthy (SG)'; color = 'bg-orange-500'; }
          else if (latest <= 200) { level = 'Unhealthy'; color = 'bg-red-500'; }
          else { level = 'Hazardous'; color = 'bg-gray-800 border border-red-500'; }
        }

        aqiCard.innerHTML = `
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="px-2 py-1 text-xs font-bold ${color} text-white rounded">${level}</span>
              <span class="text-lg font-bold">AQI ${latest || '‚Äî'}</span>
            </div>
            <p class="text-xs text-gray-400">${desc}</p>
          </div>
        `;

        if (aqiVals.length >= 6) {
          const ctx = document.getElementById('aqiChart').getContext('2d');
          if (aqiChart) aqiChart.destroy();
          
          const labels = aqiData.hourly.time.slice(0, 12).map(t => new Date(t).getHours() + ':00');
          const data = aqiData.hourly.us_aqi.slice(0, 12);
          
          aqiChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'US AQI',
                data,
                borderColor: '#3b82f6',
                borderWidth: 2,
                fill: false,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
          document.getElementById('chartSection').classList.remove('hidden');
        }

        const updateClock = () => {
          const now = new Date();
          clockCard.innerHTML = `
            <div class="text-2xl font-bold" style="font-family: monospace;">${now.toLocaleTimeString('en-US', { hour12: false })}</div>
            <div class="text-sm text-gray-400 mt-1">${country.timezones?.[0] || 'UTC'}</div>
          `;
        };
        updateClock();
        setInterval(updateClock, 1000);

      } catch (err) {
        console.error(err);
        showError(`Failed to load ${code}: ${err.message}`);
      }
    }

    async function loadGlobalData() {
      try {
        const start = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        const eqData = await cachedFetch(
          `https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=${start}&minmagnitude=4.5`
        );
        const quakes = eqData.features || [];
        document.getElementById('eqCard').innerHTML = `
          <div class="text-3xl font-bold text-red-400">${quakes.length}</div>
          <p class="text-sm text-gray-400 mt-1">‚â•4.5M (last 7 days)</p>
        `;

        if (quakes.length >= 3) {
          const top10 = quakes.slice(0, 10);
          const mags = top10.map(q => q.properties.mag);
          const places = top10.map(q => q.properties.place.split(',')[0].substring(0, 15));
          
          const ctx = document.getElementById('eqChart').getContext('2d');
          if (eqChart) eqChart.destroy();
          
          eqChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: places,
              datasets: [{
                label: 'Magnitude',
                data: mags,
                backgroundColor: '#3b82f6'
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: true,
              plugins: { legend: { display: false } },
              scales: {
                x: { beginAtZero: true }
              }
            }
          });
        }

        const newsData = await cachedFetch(
          `https://gnews.io/api/v4/top-headlines?token=${GNEWS_API_KEY}&lang=en&country=us&max=4`
        );
        const articles = newsData.articles || [];
        document.getElementById('newsGrid').innerHTML = articles.map(a => `
          <a href="${a.url}" target="_blank" rel="noopener noreferrer" class="news-item fade-in">
            <h4 class="font-semibold line-clamp-2">${a.title}</h4>
            <p class="text-xs text-gray-400 mt-1">${a.source.name} ‚Ä¢ ${new Date(a.publishedAt).toLocaleDateString()}</p>
          </a>
        `).join('') || '<p class="text-amber-400 text-center py-4">‚ö†Ô∏è No news available</p>';

      } catch (err) {
        console.warn('Global data error:', err);
      }
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorBanner').classList.remove('hidden');
      setTimeout(() => document.getElementById('errorBanner').classList.add('hidden'), 8000);
    }

    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      themeToggle.textContent = themeToggle.textContent.includes('Dark') ? '‚òÄÔ∏è Light' : 'üåô Dark';
    });

    loadCountry('US');
    loadGlobalData();
    setInterval(loadGlobalData, 10 * 60 * 1000);
  </script>
</body>
</html>
